
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Running computations in parallel &#8212; Functional Programming in Scala Specialization -- Complied Notes</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Functional Programming in Scala Specialization -- Complied Notes</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Functional Programming in Scala Specialization
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Functional Programming Principles in Scala
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week1/intro.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week1/week1_1.html">
   2. Imperative vs Functional Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week1/week1_2.html">
   3. Expressions and Evaluation model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week1/week1_3.html">
   4. Tail Recursion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week1/week1_4.html">
   5. Exercise Session
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week2/week2_1.html">
   6. Higher Order Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week2/week2_2.html">
   7. Class and Objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week3/week3_1.html">
   8. Class Hierarchies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week3/week3_2.html">
   9. How classes are organized?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week3/week3_3.html">
   10. Polymorphism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_1.html">
   11. Objects Everywhere
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_2.html">
   12. Functions as objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_3.html">
   13. Subtyping and Generics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_4.html">
   14. Variance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_5.html">
   15. Decomposition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week4/week4_6.html">
   16. Pattern Matching
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week5/week5_1.html">
   17. Lists
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week5/week5_2.html">
   18. Pairs and Tuples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week5/week5_3.html">
   19. Higher Order List Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week6/week6_1.html">
   20. Other Collections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week6/week6_2.html">
   21. Combinatorial Search and For-Expressions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week6/week6_3.html">
   22. Combinatorial Search Example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week6/week6_4.html">
   23. Maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpps/week6/week6_5.html">
   24. Putting Pieces Together
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Functional Program Design in Scala
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week1/week1_1.html">
   1. Recap Functions and Pattern Matching
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week1/week1_2.html">
   2. Recap: Collections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week1/week1_3.html">
   3. Functional Random Generators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week1/week1_4.html">
   4. Monads
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week2/week2_1.html">
   5. Streams
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week2/week2_2.html">
   6. Case Study: The Water Pouring Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week3/week3_1.html">
   7. Type-Directed Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week3/week3_2.html">
   8. Type Classes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week3/week3_3.html">
   9. Implicit Conversions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_1.html">
   10. Functions and State
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_2.html">
   11. Identity and Change
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_3.html">
   12. Loops
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_4.html">
   13. Discrete Event Simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_5.html">
   14. Discrete Event Simulation: API and Usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week4/week4_6.html">
   15. Discrete Event Simulation: Implementation and Test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week5/week5_1.html">
   16. Imperative Event Handling: The Observer Pattern
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week5/week5_2.html">
   17. Functional Reactive Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fpds/week5/week5_3.html">
   18. A Simple FRP Implementation
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Parallel Programming
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="week1_1.html">
   1. Parallelism on JVM I
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="week1_2.html">
   2. Parallelism on the JVM II
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="week1_3.html">
   3. Running Computations in Parallel
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/pp/week1/week1_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/pp/week1/week1_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Running computations in parallel
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#first-class-tasks">
   First Class Tasks
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmarking-parallel-programs">
   Benchmarking Parallel Programs
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-benchmark-parallel-programs">
     Why do we benchmark parallel programs?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scalameter">
   ScalaMeter
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="running-computations-in-parallel">
<h1>Running computations in parallel<a class="headerlink" href="#running-computations-in-parallel" title="Permalink to this headline">¶</a></h1>
<p>Consider a square and circle of radius one inside the square.</p>
<p>Ratio between surface areas of circle and square</p>
<p><span class="math notranslate nohighlight">\(\lambda = \frac{\pi}{4}\)</span></p>
<p>Estimating λ:
randomly sample points inside the square</p>
<p>Count how many fall inside the circle</p>
<p>Multiply this ratio by 4 for an estimate of <span class="math notranslate nohighlight">\(\pi\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">def</span> <span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
<span class="k">val</span> <span class="n">randomX</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span>
<span class="k">val</span> <span class="n">randomY</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span>
<span class="k">var</span> <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="n">iter</span><span class="o">)</span> <span class="o">{</span>
<span class="k">val</span> <span class="n">x</span> <span class="o">=</span> <span class="n">randomX</span><span class="o">.</span><span class="n">nextDouble</span> <span class="c1">// in [0,1]</span>
<span class="k">val</span> <span class="n">y</span> <span class="o">=</span> <span class="n">randomY</span><span class="o">.</span><span class="n">nextDouble</span> <span class="c1">// in [0,1]</span>
<span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="n">hits</span><span class="o">=</span> <span class="n">hits</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">}</span>
<span class="n">hits</span>
<span class="o">}</span>
<span class="k">def</span> <span class="n">monteCarloPiSeq</span><span class="o">(</span><span class="n">iter</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span><span class="o">)</span> <span class="o">/</span> <span class="n">iter</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">import </span><span class=" -Color -Color-Cyan">scala.util.Random</span>

defined <span class=" -Color -Color-Green">function</span> <span class=" -Color -Color-Cyan">mcCount</span>
defined <span class=" -Color -Color-Green">function</span> <span class=" -Color -Color-Cyan">monteCarloPiSeq</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">monteCarloPiSeq</span><span class="o">(</span><span class="mi">100000</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">res3</span>: <span class=" -Color -Color-Green">Double</span> = <span class=" -Color -Color-Green">3.1458</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the parallel version of computing the same estimate.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">monteCarloPiPar</span><span class="o">(</span><span class="n">iter</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
<span class="k">val</span> <span class="o">((</span><span class="n">pi1</span><span class="o">,</span> <span class="n">pi2</span><span class="o">),</span> <span class="o">(</span><span class="n">pi3</span><span class="o">,</span> <span class="n">pi4</span><span class="o">))</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">(</span>
<span class="n">parallel</span><span class="o">(</span><span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span><span class="o">/</span><span class="mi">4</span><span class="o">),</span> <span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span><span class="o">/</span><span class="mi">4</span><span class="o">)),</span>
<span class="n">parallel</span><span class="o">(</span><span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span><span class="o">/</span><span class="mi">4</span><span class="o">),</span> <span class="n">mcCount</span><span class="o">(</span><span class="n">iter</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*(</span><span class="n">iter</span><span class="o">/</span><span class="mi">4</span><span class="o">))))</span>
<span class="mf">4.0</span> <span class="o">*</span> <span class="o">(</span><span class="n">pi1</span> <span class="o">+</span> <span class="n">pi2</span> <span class="o">+</span> <span class="n">pi3</span> <span class="o">+</span> <span class="n">pi4</span><span class="o">)</span> <span class="o">/</span> <span class="n">iter</span>
<span class="o">}</span>
</pre></div>
</div>
<p>All computations are happening in parallel and independent.</p>
</div>
<div class="section" id="first-class-tasks">
<h1>First Class Tasks<a class="headerlink" href="#first-class-tasks" title="Permalink to this headline">¶</a></h1>
<p>Let’s now describe a more flexible construct for describing parallel computation. Consider</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span>
</pre></div>
</div>
<p>we can write alternatively using the <code class="docutils literal notranslate"><span class="pre">task</span></code> construct:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">task</span><span class="o">(</span><span class="n">e1</span><span class="o">)</span>
<span class="k">val</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">task</span><span class="o">(</span><span class="n">e2</span><span class="o">)</span>
<span class="k">val</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">join</span>
<span class="k">val</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">join</span>
<span class="n">t1</span>
<span class="n">t2</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"> <span class="pre">t</span> <span class="pre">=</span> <span class="pre">task(e)</span></code> starts computation <code class="docutils literal notranslate"><span class="pre">e</span></code> “in the background”</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">t</span></code> is a task, which performs computation of <code class="docutils literal notranslate"><span class="pre">e</span></code></p></li>
<li><p>current computation proceeds in parallel with <code class="docutils literal notranslate"><span class="pre">t</span></code></p></li>
<li><p>to obtain the result of <code class="docutils literal notranslate"><span class="pre">e</span></code>, use <code class="docutils literal notranslate"><span class="pre">t.join</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">t.join</span></code> blocks and waits until the result is computed</p></li>
<li><p>subsequent <code class="docutils literal notranslate"><span class="pre">t.join</span></code> calls quickly return the <code class="docutils literal notranslate"><span class="pre">s</span></code></p></li>
</ul>
<p>Here is a minimal interface for tasks:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">task</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="k">trait</span> <span class="nc">Task</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
<span class="k">def</span> <span class="n">join</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">task</span></code> and <code class="docutils literal notranslate"><span class="pre">join</span></code> establish maps between computations and tasks
In terms of the value computed the equation <code class="docutils literal notranslate"><span class="pre">task(e).join==e</span></code> holds</p>
<p>We can omit writing <code class="docutils literal notranslate"><span class="pre">.join</span></code> if we also define an implicit conversion.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">def</span> <span class="n">getJoin</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">x</span><span class="k">:</span><span class="kt">Task</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">join</span>
</pre></div>
</div>
<p>We have seen four-way parallel p-norm:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="o">((</span><span class="n">part1</span><span class="o">,</span> <span class="n">part2</span><span class="o">),(</span><span class="n">part3</span><span class="o">,</span><span class="n">part4</span><span class="o">))</span> <span class="o">=</span>
<span class="n">parallel</span><span class="o">(</span><span class="n">parallel</span><span class="o">(</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mid1</span><span class="o">),</span>
<span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid1</span><span class="o">,</span> <span class="n">mid2</span><span class="o">)),</span>
<span class="n">parallel</span><span class="o">(</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid2</span><span class="o">,</span> <span class="n">mid3</span><span class="o">),</span>
<span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid3</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span><span class="o">)))</span>
<span class="n">power</span><span class="o">(</span><span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span> <span class="o">+</span> <span class="n">part3</span> <span class="o">+</span> <span class="n">part4</span><span class="o">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="o">)</span>
</pre></div>
</div>
<p>Here is essentially the same computation expressed using task:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">task</span> <span class="o">{</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mid1</span><span class="o">)}</span>
<span class="k">val</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">task</span> <span class="o">{</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid1</span><span class="o">,</span> <span class="n">mid2</span><span class="o">)}</span>
<span class="k">val</span> <span class="n">t3</span> <span class="o">=</span> <span class="n">task</span> <span class="o">{</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid2</span><span class="o">,</span> <span class="n">mid3</span><span class="o">)}</span>
<span class="k">val</span> <span class="n">t4</span> <span class="o">=</span> <span class="n">task</span> <span class="o">{</span><span class="n">sumSegment</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">mid3</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span><span class="o">)}</span>
<span class="n">power</span><span class="o">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">t3</span> <span class="o">+</span> <span class="n">t4</span><span class="o">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="o">)</span>
</pre></div>
</div>
<p>Notice the implicit conversion of <code class="docutils literal notranslate"><span class="pre">t1</span></code>, <code class="docutils literal notranslate"><span class="pre">t2</span></code>, <code class="docutils literal notranslate"><span class="pre">t3</span></code> and <code class="docutils literal notranslate"><span class="pre">t4</span></code> in the last statement.</p>
<p>Suppose you are allowed to use task
Implement parallel construct as a method using task</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">parallel</span><span class="o">[</span><span class="kt">A</span><span class="p">,</span> <span class="kt">B</span><span class="o">](</span><span class="n">cA</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">,</span> <span class="n">cB</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">,</span> <span class="kt">B</span><span class="o">)</span> <span class="o">=</span> <span class="o">{</span>
<span class="k">val</span> <span class="n">tB</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="o">=</span> <span class="n">task</span> <span class="o">{</span> <span class="n">cB</span> <span class="o">}</span>
<span class="k">val</span> <span class="n">tA</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">cA</span>
<span class="o">(</span><span class="n">tA</span><span class="o">,</span> <span class="n">tB</span><span class="o">.</span><span class="n">join</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Suppose we want to compute computation <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>. Using <code class="docutils literal notranslate"><span class="pre">task</span></code> construct start a computation in parallel, and we continue in parallel
in thread of this function.</p>
<hr class="docutils" />
<p>What is wrong with the following definitions?</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">parallelWrong</span><span class="o">[</span><span class="kt">A</span><span class="p">,</span> <span class="kt">B</span><span class="o">](</span><span class="n">cA</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">,</span> <span class="n">cB</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">,</span> <span class="kt">B</span><span class="o">)</span> <span class="o">=</span> <span class="o">{</span>
<span class="k">val</span> <span class="n">tB</span><span class="k">:</span> <span class="kt">B</span> <span class="o">=</span> <span class="o">(</span><span class="n">task</span> <span class="o">{</span> <span class="n">cB</span> <span class="o">}).</span><span class="n">join</span>
<span class="k">val</span> <span class="n">tA</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">cA</span>
<span class="o">(</span><span class="n">tA</span><span class="o">,</span> <span class="n">tB</span><span class="o">.</span><span class="n">join</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Although, above defintion compiles it does not the benefit of parallel computation in as task <code class="docutils literal notranslate"><span class="pre">tB</span></code> completed (immediatly called join) before task <code class="docutils literal notranslate"><span class="pre">tA</span></code>.</p>
</div>
<div class="section" id="benchmarking-parallel-programs">
<h1>Benchmarking Parallel Programs<a class="headerlink" href="#benchmarking-parallel-programs" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>testing – ensures that parts of the program are behaving according to the intended behavior</p></li>
<li><p>benchmarking – computes performance metrics for parts of the program.</p></li>
</ul>
<p>By contrast benchmarking is used to evaluate various evaluation metrics of the program.</p>
<p>A performance metric could be</p>
<ul class="simple">
<li><p>running time</p></li>
<li><p>memory foot print</p></li>
<li><p>network traffic</p></li>
<li><p>disk usage</p></li>
<li><p>latency</p></li>
</ul>
<p>Often, this value is a random variable, it’s value varies from run to run.
For example if we want to test the runnning time on list reverse we could</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">xs</span> <span class="o">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
<span class="k">val</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">nanoTime</span>
<span class="n">xs</span><span class="o">.</span><span class="n">reverse</span>
<span class="n">println</span><span class="o">((</span><span class="nc">System</span><span class="o">.</span><span class="n">nanoTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5697
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">xs</span>: <span class=" -Color -Color-Green">List</span>[<span class=" -Color -Color-Green">Int</span>] = <span class=" -Color -Color-Yellow">List</span>(<span class=" -Color -Color-Green">1</span>, <span class=" -Color -Color-Green">2</span>, <span class=" -Color -Color-Green">3</span>)
<span class=" -Color -Color-Cyan">startTime</span>: <span class=" -Color -Color-Green">Long</span> = <span class=" -Color -Color-Green">37832158629139L</span>
<span class=" -Color -Color-Cyan">res11_2</span>: <span class=" -Color -Color-Green">List</span>[<span class=" -Color -Color-Green">Int</span>] = <span class=" -Color -Color-Yellow">List</span>(<span class=" -Color -Color-Green">3</span>, <span class=" -Color -Color-Green">2</span>, <span class=" -Color -Color-Green">1</span>)
</pre></div>
</div>
</div>
</div>
<p>This is a very naive way but we start with this to illustrate the purpose.</p>
<p>Typically, testing yields a binary output – a program or its part is either correct or it is not.</p>
<p>Benchmarking usually yields a continuous value, which denotes the extent to which the program is correct.</p>
<p>In our benchmarking example running time is a continous value and will be slightly different each time.</p>
<div class="section" id="why-do-we-benchmark-parallel-programs">
<h2>Why do we benchmark parallel programs?<a class="headerlink" href="#why-do-we-benchmark-parallel-programs" title="Permalink to this headline">¶</a></h2>
<p>Performance benefits are the main reason why we are writing parallel
programs in the first place.</p>
<p>Benchmarking parallel programs is even more important than benchmarking sequential programs.</p>
<p>In sequential program the only measure performance are bottlenecks of the system. Converselt,a parallel program is typically a bottleneck in the system to begin with.</p>
<p>Performance (specifically, running time) is subject to many factors:</p>
<ul class="simple">
<li><p>processor speed</p></li>
<li><p>number of processors</p></li>
<li><p>memory access latency and throughput (affects contention)</p></li>
<li><p>cache behavior (e.g. false sharing, associativity effects)</p></li>
<li><p>runtime behavior (e.g. garbage collection, JIT compilation, thread scheduling)</p></li>
</ul>
<p>The faster the processor the faster the resulting program.</p>
<p>A parallel program to some extent distribute some of its workload across different processors. The number of available processors is necessary pre-condition to improve the performance.</p>
<p>Since processors are separated from main memory with a bus they have to wait while fetching data from memory. Here we differentiate latency, which is the amount of time processor must wait since it requested data from main memory until data arrives, throughput the amount of data can be retrieved from memory per unit time.</p>
<p>These two effect memory contention.To decrease latency,high speed memory, called cache close to the processor cores which mirrors the main memory. Cache are divided into several levels. It allows to read data with out going to the bus. It boost performance by several orders of magnitude.</p>
<p>However caches makes performance analysis complicated. Caches can decrease peformance (false sharing).</p>
<p>Almost all programs run within some runtime environment, such as VM, MMU or OS. These components use garbage collection, JIT compilation or thread scheduling.</p>
<p>In reality many others drive performance.</p>
<p>Measuring performance is difficult – usually, the a performance metric is a
random variable.</p>
<ul class="simple">
<li><p>multiple repetitions</p></li>
<li><p>statistical treatment – computing mean and variance</p></li>
<li><p>eliminating outliers</p></li>
<li><p>ensuring steady state (warm-up)</p></li>
<li><p>preventing anomalies (GC, JIT compilation, aggressive optimizations)</p></li>
</ul>
<p>garbage collection can be avoided by allocating heap memory.
JIT compilation can turned off.
Compilers can make optimizations.</p>
<p>To learn more, see <em>Statistically Rigorous Java Performance Evaluation, by Georges, Buytaert, and Eeckhout</em></p>
</div>
</div>
<div class="section" id="scalameter">
<h1>ScalaMeter<a class="headerlink" href="#scalameter" title="Permalink to this headline">¶</a></h1>
<p>ScalaMeter is a benchmarking and performance regression testing
framework for the JVM.</p>
<ul class="simple">
<li><p>performance regression testing – comparing performance of the current program run against known previous runs</p></li>
<li><p>benchmarking – measuring performance of the current (part of the) program</p></li>
</ul>
<p>We will focus on benchmarking</p>
<p>First, add ScalaMeter as a dependency.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span>
<span class="s">&quot;com.storm-enroute&quot;</span> <span class="o">%%</span> <span class="s">&quot;scalameter-core&quot;</span> <span class="o">%</span> <span class="s">&quot;0.6&quot;</span>
</pre></div>
</div>
<p>Then, import the contents of the ScalaMeter package, and measure:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.scalameter._</span>
<span class="k">val</span> <span class="n">time</span> <span class="o">=</span> <span class="n">measure</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">1000000</span><span class="o">).</span><span class="n">toArray</span>
<span class="o">}</span>
<span class="n">println</span><span class="o">(</span><span class="s">s&quot;Array initialization time: </span><span class="si">$time</span><span class="s"> ms&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>When we run the above snippet in Scala REPl,we get numbers with a lot of variance. During the run JVM could have started dynamic compilation, evidence for this shorter time in few runs. Another thing could have potentially occured is garabage collection, during the runs more and more memory allocated. When it reaches certain threshold garbage collection kicks in. It happens periodically. Running time could be high for garbage collection.</p>
<p>The demo showed two very different running times on two consecutive
runs of the program.</p>
<p>When a JVM program starts, it undergoes a period of warmup, after
which it achieves its maximum performance.</p>
<ul class="simple">
<li><p>first, the program is interpreted (the program is run in interpreter, the byte code output of Scala compiler runs directly on interpreter)</p></li>
<li><p>then, parts of the program are compiled into machine code (JVM is smart enough to figure out which parts are hot parts (frequently used) , and those parts are compiled and turned into machine code</p></li>
<li><p>later, the JVM may choose to apply additional dynamic optimizations</p></li>
<li><p>eventually, the program reaches steady state</p></li>
</ul>
<p>Usually, we want to measure steady state program performance.</p>
<p>ScalaMeter <code class="docutils literal notranslate"><span class="pre">Warmer</span></code> objects run the benchmarked code until detecting
steady state.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.scalameter._</span>
<span class="k">val</span> <span class="n">time</span> <span class="o">=</span> <span class="n">withWarmer</span><span class="o">(</span><span class="k">new</span> <span class="nc">Warmer</span><span class="o">.</span><span class="nc">Default</span><span class="o">)</span> <span class="n">measure</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">1000000</span><span class="o">).</span><span class="n">toArray</span>
<span class="o">}</span>
</pre></div>
</div>
<p>ScalaMeter configuration clause allows specifying various parameters, such as the minimum and maximum number of warmup runs.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">time</span> <span class="o">=</span> <span class="n">config</span><span class="o">(</span>
<span class="nc">Key</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">minWarmupRuns</span> <span class="o">-&gt;</span> <span class="mi">20</span><span class="o">,</span>
<span class="nc">Key</span><span class="o">.</span><span class="n">exec</span><span class="o">.</span><span class="n">maxWarmupRuns</span> <span class="o">-&gt;</span> <span class="mi">60</span><span class="o">,</span>
<span class="nc">Key</span><span class="o">.</span><span class="n">verbose</span> <span class="o">-&gt;</span> <span class="kc">true</span>
<span class="o">)</span> <span class="n">withWarmer</span><span class="o">(</span><span class="k">new</span> <span class="nc">Warmer</span><span class="o">.</span><span class="nc">Default</span><span class="o">)</span> <span class="n">measure</span> <span class="o">{</span>
<span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">1000000</span><span class="o">).</span><span class="n">toArray</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Finally, ScalaMeter can measure more than just the running time.</p>
<ul class="simple">
<li><p>Measurer.Default – plain running time</p></li>
<li><p>IgnoringGC – running time without GC pauses</p></li>
<li><p>OutlierElimination – removes statistical outliers</p></li>
<li><p>MemoryFootprint – memory footprint of an object</p></li>
<li><p>GarbageCollectionCycles – total number of GC pauses</p></li>
<li><p>newer ScalaMeter versions can also measure method invocation counts and boxing counts</p></li>
</ul>
<p>To measure the memory footprint</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">withMeasurer</span><span class="o">(</span><span class="k">new</span> <span class="nc">Measurer</span><span class="o">.</span><span class="nc">MemoryFootprint</span><span class="o">)</span> <span class="n">withWarmer</span><span class="o">(</span> <span class="k">new</span> <span class="nc">Warmer</span><span class="o">.</span><span class="nc">Default</span><span class="o">)</span>  <span class="n">measure</span> <span class="o">{</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">100000</span><span class="o">).</span><span class="n">toArray</span><span class="o">}</span>
</pre></div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "scala"
        },
        kernelOptions: {
            kernelName: "scala",
            path: "./pp/week1"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'scala'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Vikram Bhatt<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>